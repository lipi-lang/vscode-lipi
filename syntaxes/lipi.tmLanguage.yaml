# yaml-language-server: $schema=https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json
---
name: Lipi
scopeName: source.lipi

patterns:
  - include: '#comment'
  - include: '#atom'

repository:
  # --------
  # COMMENTS
  # --------

  comment:
    patterns:
      - include: '#comment-shebang'
      - include: '#comment-line'
      - include: '#comment-block'

  # Shebang interpreter directives
  comment-shebang:
    name: comment.line.lipi
    begin: ^#!
    end: \n

  # Line comments
  comment-line:
    name: comment.line.lipi
    begin: ;
    end: \n

  # Block comments that may be nested
  comment-block:
    name: comment.block.lipi
    begin: '#_(%*)\('
    end: \)\1
    patterns:
      - include: '#comment-block'

  # -----
  # ATOMS
  # -----

  # The smallest divisible element in a Lipi program
  atom:
    patterns:
      - include: '#atom-keyword'
      - include: '#atom-number'
      - include: '#atom-character'
      - include: '#atom-string'
      - include: '#atom-sexp'

  # A symbolic identifier that evaluates to itself
  atom-keyword:
    name: entity.name.tag.lipi
    match: (?<=^|[(\[\{\s]):{1,2}([[:alpha:]!$?*\-=_+<>.?][\/[:alnum:]!$?*\-=_+<>.?]*)(?=[,\s\}\]\)])

  # A numeric literal representing an integer or float
  atom-number:
    patterns:
      # A number literal with custom base
      - name: constant.numeric.lipi
        match: (?<=^|[(\[\{\s])~?(#(?:3[0-6]|[12][0-9]|[2-9])')([0-9A-Za-z_]+)('?[Ee](?:-|\+?)[[:digit:]]+)?(?=[,\s\}\]\)])

      # A number literal with default decimal base
      - name: constant.numeric.lipi
        match: (?<=^|[(\[\{\s])~?[[:digit:]][[:digit:]_]*(?:\.[[:digit:]_]+)?('?[Ee](?:-|\+?)[[:digit:]]+)?(?=[,\s\}\]\)])

  # A sequence of characters that represent a Unicode code point
  atom-character:
    name: string.other.lipi
    match: (?<=^|[(\[\{\s])\\(\\(u{[[:alnum:]]*}|[^\s\}\]\)]+)|.)(?=[,\s\}\]\)])

  atom-string:
    patterns:
      - include: '#atom-string-triple-raw'
      - include: '#atom-string-triple-static'
      - include: '#atom-string-double-raw'
      - include: '#atom-string-double-static'

  atom-string-triple-raw:
    name: string.quoted.triple.lipi
    begin: '#"{3}'
    end: '"{3}'

  atom-string-triple-static:
    name: string.quoted.triple.lipi
    begin: '"{3}'
    end: '"{3}'

  atom-string-double-raw:
    name: string.quoted.double.lipi
    begin: '#"{1}'
    end: '"{1}'

  atom-string-double-static:
    name: string.quoted.double.lipi
    begin: '"{1}'
    end: '"{1}'

  atom-sexp:
    begin: (?<!')\(\s*(?!:)(?:(->{1,2}|and|case|cond|declare|def[\.~!%^&*\-=_+|\\:'<>\/?\p{L}\p{Sm}\p{Sc}\p{M}\p{N}]*|derives|do|forall|fn|if(?:-let)?|let|modulus|or|range|(?:import|use|using)|(?:first|last)|(?:either|record|union))(?=[\s\)])|(@?[\.~!^&*\-=_+|\\:'<>\/?\p{L}\p{Sm}\p{Sc}][\.~!%^&*\-=_+|\\:'<>\/?\p{L}\p{Sm}\p{Sc}\p{M}\p{N}]*))
    end: \)
    beginCaptures:
      '1': { name: 'storage.type.lipi keyword.other.lipi' }
      '2': { name: entity.name.function.lipi }
    patterns:
      - include: $self
