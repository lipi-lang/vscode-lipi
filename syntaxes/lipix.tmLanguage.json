{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "Lipi Extended",
  "patterns": [
    { "include": "#comment" },
    { "include": "#scope-block" },
    { "include": "#top-level" }
  ],
  "repository": {
    "common-typed-param": {
      "match": "([[:alnum:]'_-]+)\\s*(:)\\s*([[:alnum:]'._-]+)",
      "captures": {
        "1": { "name": "variable.parameter" },
        "2": { "name": "keyword.operator" },
        "3": { "name": "entity.name.type" }
      }
    },
    "comment": {
      "patterns": [
        { "include": "#comment-block" },
        { "include": "#comment-line" }
      ]
    },
    "comment-line": {
      "name": "comment.line.lipi",
      "begin": "#",
      "end": "\n"
    },
    "comment-block": {
      "name": "comment.block.lipi",
      "begin": "#(%*)\\[",
      "end": "\\]\\1#",
      "patterns": [{ "include": "#comment-block" }]
    },
    "scope-block": {
      "begin": "(<{3})",
      "end": "(>{3})",
      "beginCaptures": { "1": { "name": "string" } },
      "endCaptures": { "1": { "name": "string" } }
    },
    "top-level": {
      "patterns": [{ "include": "#declaration" }, { "include": "#expression" }]
    },
    "declaration": {
      "patterns": [
        { "include": "#comment" },
        { "include": "#declaration-module" },
        { "include": "#declaration-type" },
        { "include": "#declaration-alias" },
        { "include": "#declaration-function" },
        { "include": "#declaration-binding" }
      ]
    },
    "declaration-module": {
      "begin": "(?<=^|\\s)(defmodule)\\s+([[:alpha:]][[:alnum:]'_-]*)\\s*(\\*)?\\s+(is)",
      "end": "(end)",
      "beginCaptures": {
        "1": { "name": "keyword" },
        "2": { "name": "entity.name.class" },
        "3": { "name": "keyword.operator" },
        "4": { "name": "keyword" }
      },
      "endCaptures": {
        "1": { "name": "keyword" }
      },
      "patterns": [{ "include": "#declaration" }]
    },
    "declaration-type": {
      "match": "(?<=^|\\s)(deftype)\\s+([[:alpha:]][[:alnum:]'_-]*)\\s*(\\*)?\\s+(=)",
      "captures": {
        "1": { "name": "keyword" },
        "2": { "name": "entity.name.type" },
        "3": { "name": "keyword.operator" },
        "4": { "name": "keyword" }
      }
    },
    "declaration-alias": {
      "match": "(?<=^|\\s)(defalias)\\s+([[:alpha:]][[:alnum:]'_-]*)\\s*(\\*)?\\s+(=)",
      "captures": {
        "1": { "name": "keyword" },
        "2": { "name": "entity.name.type" },
        "3": { "name": "keyword.operator" },
        "4": { "name": "keyword" }
      }
    },
    "declaration-function": {
      "begin": "(?<=^|\\s)(def)\\s+([[:alpha:]][[:alnum:]'_-]*)\\s*(\\*)?\\s*(\\(.*\\))(\\s*(:)\\s+([[:alpha:]][[:alnum:]'_-]*))?\\s+(is)",
      "end": "(end)",
      "beginCaptures": {
        "1": { "name": "keyword" },
        "2": { "name": "entity.name.function" },
        "3": { "name": "keyword.operator" },
        "4": { "patterns": [{ "include": "#common-typed-param" }] },
        "6": { "name": "keyword.operator" },
        "7": { "name": "entity.name.type" },
        "8": { "name": "keyword" }
      },
      "endCaptures": {
        "1": { "name": "keyword" }
      },
      "patterns": [{ "include": "#declaration" }, { "include": "#expression" }]
    },
    "declaration-binding": {
      "patterns": [
        {
          "match": "([[:alpha:]][[:alnum:]'_-]*)\\s*(=)(?=\\w|\\s)\\s*(.*)",
          "captures": {
            "1": { "name": "constant.language" },
            "2": { "name": "keyword.operator" },
            "3": { "patterns": [{ "include": "#expression" }] }
          }
        }
      ]
    },
    "expression": {
      "patterns": [
        { "include": "#expression-literal" },
        { "include": "#expression-function-invocation" },
        { "include": "#expression-if" },
        { "include": "#expression-when" }
      ]
    },
    "expression-literal": {
      "patterns": [
        {
          "type": "string literal expression",
          "name": "string",
          "begin": "(\")",
          "end": "(\")"
        },
        {
          "type": "atom literal expression",
          "name": "keyword.control",
          "match": ":[[:alpha:]][[:alnum:]'_-]*"
        },
        {
          "type": "number literal expression",
          "name": "constant.numeric",
          "match": "(?<![[:alnum:]'._-])[0-9]+(?:\\.[0-9]+)?"
        }
      ]
    },
    "expression-function-invocation": {
      "match": "((?:[[:alpha:]][[:alnum:]'_-]*\\.)+)?([[:alpha:]][[:alnum:]'_-]*)(?=\\w*\\()",
      "captures": {
        "1": {
          "name": "entity.name.class",
          "patterns": [{ "name": "keyword.operator", "match": "\\." }]
        },
        "2": { "name": "entity.name.function" }
      }
    },
    "expression-when": {
      "begin": "(?<=^|\\s)(when)(.*)(is)",
      "end": "(end)",
      "beginCaptures": {
        "1": { "name": "keyword" },
        "2": { "patterns": [{ "include": "#expression" }] },
        "3": { "name": "keyword" }
      },
      "endCaptures": {
        "1": { "name": "keyword" }
      }
    }
  },
  "scopeName": "source.lipi-extended"
}
